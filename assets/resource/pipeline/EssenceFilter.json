{
    "EssenceFilterMain": {
        "doc": "入口点",
        "next": ["EssenceFilterCheckInInventory"]
    },
    "EssenceFilterCheckInInventory": {
        "doc": "检查是否在背包Essence页",
        "recognition": {
            "type": "TemplateMatch",
            "param": {
                "template": "EssenceFilter/EssenceSlot.png",
                "threshold": 0.8,
                "roi": [
                    20,
                    46,
                    74,
                    30
                ]
            }
        },
        "next": [
            "FirstSwipeToTop",
            "EssenceFilterNavigateToInventory"
        ],
        "focus": {
            "Node.Action.Succeeded": "确认在基质界面"
        }
    },
    "FirstSwipeToTop": {
        "doc": "初始化位置，滑动到顶端",
        "action": {
            "type": "Swipe",
            "param": {
                "begin": [
                    500,
                    100
                ],
                "end": [
                    500,
                    500
                ],
                "duration": 100,
                "end_hold": 5
            }
        },
        "repeat": 3,
        "post_delay": 500,
        "next": ["EssenceFilterInit"],
        "focus": {
            "Node.Action.Succeeded": "滑动到顶端"
        }
    },
    "EssenceFilterNavigateToInventory": {
        "doc": "导航",
        "action": "DoNothing",
        "next": ["EssenceFilterFinish"],
        "focus": {
            "Node.Action.Succeeded": "不在基质界面"
        }
    },
    "EssenceFilterInit": {
        "doc": "初始化：加载数据与预设",
        "action": {
            "type": "Custom",
            "param": {
                "custom_action": "EssenceFilterInitAction",
                "custom_action_param": {
                    "preset_name": "Rarity6Weapons"
                }
            }
        },
        "next": [
            "OCREssenceInventoryNumber",
            "EssenceRowDetect",
            "EssenceDetectFinal",
            "EssenceFilterFinish"
        ],
        "focus": {
            "Node.Action.Succeeded": "初始化完成"
        }
    },

    "OCREssenceInventoryNumber": {
        "doc": "OCR 识别背包中的基质数量",
        "rate_limit": 300,
        "timeout": 1500,
        "recognition": {
            "type": "OCR",
            "param": {
                "roi": [
                    93,
                    48,
                    74,
                    22
                ],
                "expected": ["\\d+(\\/\\d+)?"],
                "threshold": 0.3,
                "only_rec": true
            }
        },
        "action": {
            "type": "Custom",
            "param": {
                "custom_action": "OCREssenceInventoryNumberAction"
            }
        },
        "next": [
            "EssenceRowDetect",
            "EssenceDetectFinal",
            "EssenceFilterFinish"
        ]
    },

    "EssenceRowDetect": {
        "doc": "整行模板匹配，收集所有格子",
        "recognition": {
            "type": "TemplateMatch",
            "param": {
                "template": "EssenceFilter/EssenceGeneral.png",
                "threshold": 0.45,
                // "threshold": 0.55,
                "roi": [
                    18,
                    72,
                    956,
                    119
                ],
                "method": 5
            }
        },
        "action": {
            "type": "Custom",
            "param": {
                "custom_action": "EssenceFilterRowCollectAction"
            }
        },
        "next": [
            "EssenceFilterRowNextItem",
            "EssenceDetectFinal"
        ]
    },
    "EssenceDetectFinal": {
        "doc": "尾扫：扩大 ROI 捕获底部剩余行",
        "recognition": {
            "type": "TemplateMatch",
            "param": {
                "template": "EssenceFilter/EssenceGeneral.png",
                "threshold": 0.45,
                // "threshold": 0.55,
                "roi": [
                    18,
                    72,
                    956,
                    570
                ], // 高度放大，覆盖底部区域
                "method": 5
            }
        },
        "action": {
            "type": "Custom",
            "param": {
                "custom_action": "EssenceFilterRowCollectAction"
            }
        },
        "next": [
            "EssenceFilterRowNextItem"
        ]
    },

    "EssenceFilterCheckItemSlot1": {
        "doc": "OCR 识别技能槽 1",
        "rate_limit": 300,
        "timeout": 1500,
        "recognition": {
            "type": "OCR",
            "param": {
                "roi": [
                    1000,
                    235,
                    115,
                    27
                ],
                "expected": [".*"],
                "threshold": 0.3,
                "only_rec": true
            }
        },
        "action": {
            "type": "Custom",
            "param": {
                "custom_action": "EssenceFilterCheckItemAction",
                "custom_action_param": {
                    "slot": 1,
                    "is_last": false
                }
            }
        },
        "next": [
            "EssenceFilterCheckItemSlot2",
            "EssenceFilterCheckItemOCRFallback"
        ]
    },
    "EssenceFilterCheckItemSlot2": {
        "doc": "OCR 识别技能槽 2",
        "rate_limit": 300,
        "timeout": 1500,
        "recognition": {
            "type": "OCR",
            "param": {
                "roi": [
                    1000,
                    272,
                    115,
                    27
                ],
                "expected": [".*"],
                "threshold": 0.3,
                "only_rec": true
            }
        },
        "action": {
            "type": "Custom",
            "param": {
                "custom_action": "EssenceFilterCheckItemAction",
                "custom_action_param": {
                    "slot": 2,
                    "is_last": false
                }
            }
        },
        "next": [
            "EssenceFilterCheckItemSlot3",
            "EssenceFilterCheckItemOCRFallback"
        ]
    },
    "EssenceFilterCheckItemSlot3": {
        "doc": "OCR 识别技能槽 3",
        "rate_limit": 300,
        "timeout": 1500,
        "recognition": {
            "type": "OCR",
            "param": {
                "roi": [
                    1000,
                    309,
                    115,
                    27
                ],
                "expected": [".*"],
                "threshold": 0.3,
                "only_rec": true
            }
        },
        "action": {
            "type": "Custom",
            "param": {
                "custom_action": "EssenceFilterCheckItemAction",
                "custom_action_param": {
                    "slot": 3,
                    "is_last": true
                }
            }
        },
        "next": [
            "EssenceFilterSkillDecision",
            "EssenceFilterCheckItemOCRFallback"
        ]
    },
    "EssenceFilterCheckItemOCRFallback": {
        "doc": "OCR 超时：跳过",
        "recognition": {"type": "DirectHit", "param": {}},
        "action": {"type": "DoNothing"},
        "next": ["EssenceFilterRowNextItem"],
        "focus": {"Node.Action.Failed": "OCR 超时：跳过"}
    },

    "EssenceFilterSkillDecision": {
        "doc": "匹配技能并决定是否上锁",
        "action": {
            "type": "Custom",
            "param": {
                "custom_action": "EssenceFilterSkillDecisionAction"
            }
        },
        "next": ["EssenceFilterRowNextItem"]
    },

    "EssenceFilterLockItemLog": {
        "doc": "日志：即将锁定Essence",
        "action": {
            "type": "Custom",
            "param": {
                "custom_action": "EssenceFilterTraceAction",
                "custom_action_param": {
                    "step": "LockItem"
                }
            }
        },
        "next": [
            "EssenceFilterCheckLocked",
            "EssenceFilterLockItem"
        ]
    },

    "EssenceFilterLockItem": {
        "doc": "锁定Essence",
        "recognition": {
            "type": "TemplateMatch",
            "param": {
                "template": "EssenceFilter/LockButton.png",
                "threshold": 0.9,
                "roi": [
                    1217,
                    180,
                    21,
                    21
                ]
            }
        },
        "action": {
            "type": "Click"
        },
        "post_delay": 300,
        "next": [
            "EssenceFilterCheckLocked",
            "EssenceFilterLockItem"
        ],
        "focus": {
            "Node.Action.Succeeded": "已锁定基质"
        }
    },
    "EssenceFilterCheckLocked": {
        "doc": "确认已上锁",
        "recognition": {
            "type": "TemplateMatch",
            "param": {
                "template": "EssenceFilter/LockButtonLocked.png",
                "threshold": 0.9,
                "roi": [
                    1217,
                    180,
                    21,
                    21
                ]
            }
        },
        "next": ["EssenceFilterRowNextItem"],
        "on_error": ["EssenceFilterLockItem"],
        "focus": {
            "Node.Action.Succeeded": "已确认上锁"
        }
    },

    "EssenceFilterRowNextItem": {
        "doc": "处理下一个命中的格子，或滑动/结束",
        "action": {
            "type": "Custom",
            "param": {
                "custom_action": "EssenceFilterRowNextItemAction"
            }
        },
        "next": ["EssenceFilterFinish"]
    },

    "EssenceFilterSwipeFirst": {
        "doc": "首行滑动",
        "action": {
            "type": "Swipe",
            "param": {
                "begin": [
                    135,
                    191
                ],
                "end": [
                    135,
                    75
                ],
                "duration": 100,
                "end_hold": 1500
            }
        },
        "post_delay": 200,
        "next": [
            "EssenceRowDetect",
            "EssenceDetectFinal"
        ]
    },
    "EssenceFilterSwipeNext": {
        "doc": "后续滑动",
        "action": {
            "type": "Swipe",
            "param": {
                "begin": [
                    135,
                    191
                ],
                "end": [
                    135,
                    76
                ],
                "duration": 100,
                "end_hold": 1500
            }
        },
        "post_delay": 200,
        "next": [
            "EssenceRowDetect",
            "EssenceDetectFinal"
        ]
    },

    "EssenceFilterFinish": {
        "doc": "任务完成",
        "action": {
            "type": "Custom",
            "param": {
                "custom_action": "EssenceFilterFinishAction"
            }
        },
        "focus": {
            "Node.Action.Succeeded": "任务完成"
        }
    }
}
